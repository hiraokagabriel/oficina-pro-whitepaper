// Oficina PRO ERP - Database Schema
// Scalable and extensible design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(MECHANIC)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workOrders        WorkOrder[]     @relation("AssignedMechanic")
  createdWorkOrders WorkOrder[]     @relation("CreatedBy")
  ledgerEntries     LedgerEntry[]   @relation("CreatedBy")
  appointments      Appointment[]
  activityLogs      ActivityLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  MECHANIC
  RECEPTIONIST
}

// ============================================
// CLIENT MANAGEMENT
// ============================================

model Client {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  phone     String
  cpf       String?  @unique
  address   String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicles   Vehicle[]
  workOrders WorkOrder[]

  @@index([phone])
  @@index([cpf])
  @@map("clients")
}

// ============================================
// VEHICLE MANAGEMENT
// ============================================

model Vehicle {
  id           String   @id @default(uuid())
  clientId     String
  brand        String
  model        String
  year         Int?
  plate        String?  @unique
  vin          String?  @unique
  color        String?
  mileage      Int?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  client     Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]

  @@index([plate])
  @@index([clientId])
  @@map("vehicles")
}

// ============================================
// WORK ORDER MANAGEMENT
// ============================================

model WorkOrder {
  id               String          @id @default(uuid())
  clientId         String
  vehicleId        String?
  status           WorkOrderStatus @default(ESTIMATE)
  priority         Priority        @default(NORMAL)
  vehicleDesc      String          // Legacy support
  publicNotes      String?
  internalNotes    String?
  total            Decimal         @default(0) @db.Decimal(10, 2)
  discount         Decimal         @default(0) @db.Decimal(10, 2)
  tax              Decimal         @default(0) @db.Decimal(10, 2)
  finalTotal       Decimal         @default(0) @db.Decimal(10, 2)
  estimatedHours   Decimal?        @db.Decimal(5, 2)
  actualHours      Decimal?        @db.Decimal(5, 2)
  assignedToId     String?
  createdById      String
  approvedAt       DateTime?
  startedAt        DateTime?
  finishedAt       DateTime?
  deliveredAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  client       Client            @relation(fields: [clientId], references: [id])
  vehicle      Vehicle?          @relation(fields: [vehicleId], references: [id])
  assignedTo   User?             @relation("AssignedMechanic", fields: [assignedToId], references: [id])
  createdBy    User              @relation("CreatedBy", fields: [createdById], references: [id])
  items        WorkOrderItem[]
  ledgerEntry  LedgerEntry?
  attachments  Attachment[]
  statusHistory StatusHistory[]

  @@index([status])
  @@index([clientId])
  @@index([vehicleId])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("work_orders")
}

enum WorkOrderStatus {
  ESTIMATE
  APPROVED
  IN_PROGRESS
  COMPLETED
  DELIVERED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================
// WORK ORDER ITEMS (Services & Parts)
// ============================================

model WorkOrderItem {
  id           String         @id @default(uuid())
  workOrderId  String
  type         ItemType
  description  String
  quantity     Decimal        @db.Decimal(10, 2)
  unitPrice    Decimal        @db.Decimal(10, 2)
  subtotal     Decimal        @db.Decimal(10, 2)
  serviceId    String?
  partId       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  service   Service?  @relation(fields: [serviceId], references: [id])
  part      Part?     @relation(fields: [partId], references: [id])

  @@index([workOrderId])
  @@map("work_order_items")
}

enum ItemType {
  SERVICE
  PART
}

// ============================================
// SERVICES CATALOG
// ============================================

model Service {
  id             String   @id @default(uuid())
  name           String
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  estimatedTime  Decimal? @db.Decimal(5, 2) // hours
  categoryId     String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  category       ServiceCategory? @relation(fields: [categoryId], references: [id])
  workOrderItems WorkOrderItem[]

  @@index([name])
  @@index([categoryId])
  @@map("services")
}

model ServiceCategory {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  services Service[]

  @@map("service_categories")
}

// ============================================
// PARTS INVENTORY
// ============================================

model Part {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  description    String?
  brand          String?
  price          Decimal  @db.Decimal(10, 2)
  cost           Decimal? @db.Decimal(10, 2)
  stock          Int      @default(0)
  minStock       Int      @default(0)
  maxStock       Int?
  location       String?
  supplierId     String?
  categoryId     String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  supplier       Supplier?         @relation(fields: [supplierId], references: [id])
  category       PartCategory?     @relation(fields: [categoryId], references: [id])
  workOrderItems WorkOrderItem[]
  movements      StockMovement[]

  @@index([code])
  @@index([name])
  @@index([supplierId])
  @@map("parts")
}

model PartCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parts Part[]

  @@map("part_categories")
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  cnpj      String?  @unique
  email     String?
  phone     String?
  address   String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parts Part[]

  @@map("suppliers")
}

model StockMovement {
  id          String       @id @default(uuid())
  partId      String
  type        MovementType
  quantity    Int
  unitPrice   Decimal?     @db.Decimal(10, 2)
  totalPrice  Decimal?     @db.Decimal(10, 2)
  reason      String?
  reference   String?      // Order ID, Return ID, etc
  createdAt   DateTime     @default(now())

  // Relations
  part Part @relation(fields: [partId], references: [id])

  @@index([partId])
  @@index([createdAt])
  @@map("stock_movements")
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
}

// ============================================
// FINANCIAL MANAGEMENT
// ============================================

model LedgerEntry {
  id          String      @id @default(uuid())
  type        EntryType
  amount      Decimal     @db.Decimal(10, 2)
  description String
  category    String?
  date        DateTime
  workOrderId String?     @unique
  createdById String
  isPaid      Boolean     @default(false)
  paidAt      DateTime?
  paymentMethod String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  workOrder WorkOrder? @relation(fields: [workOrderId], references: [id])
  createdBy User       @relation("CreatedBy", fields: [createdById], references: [id])

  @@index([type])
  @@index([date])
  @@index([category])
  @@map("ledger_entries")
}

enum EntryType {
  INCOME
  EXPENSE
}

// ============================================
// APPOINTMENTS & SCHEDULING
// ============================================

model Appointment {
  id          String            @id @default(uuid())
  clientName  String
  clientPhone String
  vehicleInfo String
  scheduledAt DateTime
  duration    Int               // minutes
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?
  assignedToId String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  assignedTo User? @relation(fields: [assignedToId], references: [id])

  @@index([scheduledAt])
  @@index([status])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================
// ATTACHMENTS & FILES
// ============================================

model Attachment {
  id           String   @id @default(uuid())
  workOrderId  String
  fileName     String
  fileType     String
  fileSize     Int
  fileUrl      String
  description  String?
  uploadedAt   DateTime @default(now())

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("attachments")
}

// ============================================
// AUDIT & HISTORY
// ============================================

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entity     String
  entityId   String
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

model StatusHistory {
  id          String          @id @default(uuid())
  workOrderId String
  oldStatus   WorkOrderStatus?
  newStatus   WorkOrderStatus
  changedBy   String
  reason      String?
  createdAt   DateTime        @default(now())

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([createdAt])
  @@map("status_history")
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   // 'string', 'number', 'boolean', 'json'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}
